<!DOCTYPE html>
<head>
  <style>
    iframe { width: 400px; height: 200px;}
  </style>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
</head>
<body>
    <p>This tests that an iframe in sandbox with 'allow-top-navigation-by-user-activation'
    can navigate the top level page, if it is trigged by a user gesture.</p>
    <iframe id="i" sandbox="allow-scripts allow-top-navigation-by-user-activation"></iframe>
    <script>
      promise_test(async (t) => {
        var iframe = document.getElementById("i");

        // Listener that checks to see if the test was not successful
        const resultPromise = new Promise(resolve => {
          window.addEventListener('message', function handler(evt) {
            if (evt.data == "parent.location failed") {
              window.removeEventListener('message', handler);
              resolve(evt.data);
            }
          });
        });

        // Listener for when the iframe is ready to run the test
        const readyPromise = new Promise(resolve => {
          window.addEventListener('message', function handler(evt) {
            if (evt.source === iframe.contentWindow && evt.data == 'Loaded') {
              window.removeEventListener('message', handler);
              resolve(evt.data);
            }
          });
        });

        // Load the iframe and wait until it says it's fully loaded.
        iframe.src = "resources/iframe-that-performs-parent-navigation.html";
        await readyPromise;

        // The iframe will attempt to navigate the top. If successful, it will
        // navigate away from this page to `navigation-changed-iframe.html`.
        frames[0].postMessage("begin test", "*");

        // This promise will only resolve if the iframe failed to navigate top.
        const result = await resultPromise;
        assert_unreached("The iframe should have navigated this page.");
      });
    </script>
</body>
</html>
